以下に、**Embassy** と **probe-rs** の概要、およびそれらを使った組み込み開発の進め方を Markdown 形式でまとめます。

---

# Embassy と probe-rs を用いた組み込み開発ガイド

## 1. Embassy とは

**Embassy** は、Rust 用の **非同期(Async)組み込み開発フレームワーク** です。

### 特徴

* **async/await 対応**
  組み込みマイコン上で async/await を利用可能にし、効率的なノンブロッキング処理が書ける。
* **複数プラットフォーム対応**
  Nordic (nRF)、STM32、RP2040 など多数のMCU向けサポート。
* **ハードウェア抽象化 (HAL)**
  ピンやペリフェラルを型安全に操作可能。
* **低リソース消費**
  組み込み向けに最適化され、RTOS不要でタスク並列処理ができる。

### 主な用途

* BLE通信、UART、I2C、SPI制御
* センサー読み取り
* LEDやモーター制御
* 非同期タスクのスケジューリング

---

## 2. probe-rs とは

**probe-rs** は、Rust 製の **デバッグ・フラッシュツール** です。

### 特徴

* **クロスプラットフォーム**（Windows, macOS, Linux）
* JTAG / SWD 対応
* `nrfjprog` や `openocd` の代替として利用可能
* GDB サーバー機能搭載（`probe-rs gdb`）
* フラッシュ書き込み、レジスタ読み取り、メモリダンプなど可能

### 主なコマンド例

```bash
# 接続可能なデバッグプローブを一覧表示
probe-rs list

# バイナリをフラッシュして実行
probe-rs run --chip nRF52832_xxAA target/thumbv7em-none-eabihf/release/blinky

# メモリ読み出し（32bit幅）
probe-rs read b32 0x20000000 4

# GDBサーバーとして起動
probe-rs gdb --chip nRF52832_xxAA
```

---

## 3. 開発環境の流れ

### 3.1 開発準備

1. **Rustのインストール**

   ```bash
   rustup target add thumbv7em-none-eabihf
   ```
2. **embassy と HAL の依存追加**

   ```toml
   [dependencies]
   embassy-executor = { version = "0.14", features = ["arch-cortex-m", "executor-thread"] }
   embassy-nrf = { version = "0.14", features = ["nrf52832", "time-driver-rtc1", "gpiote"] }
   panic-halt = "0.2"
   ```
3. **debug probe の用意**

   * J-Link, ST-Link, CMSIS-DAP など
   * Nordic純正DKはオンボードCMSIS-DAPが使える

---

### 3.2 ビルドと書き込み

1. **ビルド**

   ```bash
   cargo build --release
   ```
2. **書き込み**

   ```bash
   probe-rs run --chip nRF52832_xxAA target/thumbv7em-none-eabihf/release/blinky
   ```

---

### 3.3 デバッグ

```bash
# GDBサーバーを起動
probe-rs gdb --chip nRF52832_xxAA

# 別ターミナルで接続
arm-none-eabi-gdb target/thumbv7em-none-eabihf/debug/blinky
```

---

## 4. よくあるトラブルと対策

| 症状               | 原因            | 対策                              |
| ---------------- | ------------- | ------------------------------- |
| LEDが点灯しない        | ボードのピン番号が違う   | データシートで該当LEDのGPIO番号を確認          |
| `chip not found` | 指定チップ名が曖昧     | `probe-rs list-chips` で正しい名前を確認 |
| HardFault発生      | メモリマップ不一致     | `memory.x` をターゲットMCU用に修正        |
| SWD接続エラー         | リセットピン設定や配線ミス | `--connect-under-reset` を試す     |

---

## 5. 参考リンク

* [Embassy GitHub](https://github.com/embassy-rs/embassy)
* [probe-rs GitHub](https://github.com/probe-rs/probe-rs)
* [Nordic PCA10040 Product Page](https://www.nordicsemi.com/Products/Development-hardware/nRF52-DK)

---

この内容をベースに、実際の**PCA10040 (nRF52832)** 用の **LED点滅サンプル** もすぐに作れます。
もし希望があれば、**embassy用Blinkyの完全コード**も添えます。
